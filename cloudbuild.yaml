steps:
  # 1. Build and Push Application and Database
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build & Push All'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker build -t ${_REGION_SHORT}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/pacs-migrations:${SHORT_SHA} -f backend/migrations/Dockerfile.flyway backend/.
        docker build -t ${_REGION_SHORT}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/pacs-backend:${SHORT_SHA} backend/.
        docker build -t ${_REGION_SHORT}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/pacs-ui:${SHORT_SHA} frontend/.
        
        docker push ${_REGION_SHORT}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/pacs-migrations:${SHORT_SHA}
        docker push ${_REGION_SHORT}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/pacs-backend:${SHORT_SHA}
        docker push ${_REGION_SHORT}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/pacs-ui:${SHORT_SHA}

  # 2. Database Migration (Sidecar-Aware Logic)
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Migrate DB'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud components install gke-gcloud-auth-plugin --quiet
        gcloud container clusters get-credentials ${_CLUSTER_NAME} --zone ${_REGION} --project ${PROJECT_ID}
        
        # Cleanup old job
        kubectl delete job pacs-migration-job --ignore-not-found
        
        # Apply the migration job
        sed "s|image: .*pacs-migrations:.*|image: ${_REGION_SHORT}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/pacs-migrations:${SHORT_SHA}|g" k8s/flyway-job.yaml > flyway-run.yaml
        kubectl apply -f flyway-run.yaml
        
        echo "Monitoring Flyway logs (ignoring sidecar status)..."
        # Poll for 2 minutes
        for i in {1..24}; do
          LOGS=$$(kubectl logs -l job-name=pacs-migration-job -c flyway 2>/dev/null)
          
          # Check for successful application OR already up to date
          if echo "$$LOGS" | grep -qE "Successfully applied|is up to date"; then
            echo "SUCCESS: Database is ready."
            # Force delete the job to kill the Cloud SQL Proxy sidecar
            kubectl delete job pacs-migration-job
            exit 0
          fi
          
          # Check for errors
          if echo "$$LOGS" | grep -q "Migration failed"; then
            echo "ERROR: Flyway migration failed."
            echo "$$LOGS"
            exit 1
          fi
          
          echo "Waiting for Flyway output... (attempt $$i/24)"
          sleep 5
        done

        echo "ERROR: Timeout waiting for Flyway logs."
        kubectl describe job pacs-migration-job
        exit 1
    env:
      - 'CLOUDSDK_COMPUTE_ZONE=${_REGION}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'
      - 'USE_GKE_GCLOUD_AUTH_PLUGIN=True'

  # 3. Deploy Updates
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Deploy Updates'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud container clusters get-credentials ${_CLUSTER_NAME} --zone ${_REGION} --project ${PROJECT_ID}
        kubectl set image deployment/pacs-backend pacs-api=${_REGION_SHORT}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/pacs-backend:${SHORT_SHA}
        kubectl set image deployment/pacs-frontend pacs-ui=${_REGION_SHORT}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/pacs-ui:${SHORT_SHA}
        kubectl rollout status deployment/pacs-backend
        kubectl rollout status deployment/pacs-frontend
    env:
      - 'CLOUDSDK_COMPUTE_ZONE=${_REGION}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'
      - 'USE_GKE_GCLOUD_AUTH_PLUGIN=True'

substitutions:
  _REGION: us-central1-a
  _REGION_SHORT: us-central1
  _REPO_NAME: pacs-repo
  _CLUSTER_NAME: mwakilishi-cluster

options:
  logging: CLOUD_LOGGING_ONLY
  substitution_option: 'ALLOW_LOOSE'