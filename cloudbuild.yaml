steps:
  # Step 1: Build the Migration Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Migration Image'
    dir: 'backend'
    args:
      - 'build'
      - '-t'
      - '${_REGION_SHORT}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/pacs-migrations:${SHORT_SHA}'
      - '-f'
      - 'migrations/Dockerfile.flyway'
      - '.'

  # Step 2: Push the image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Image'
    args:
      - 'push'
      - '${_REGION_SHORT}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/pacs-migrations:${SHORT_SHA}'

  # Step 3: Run Migration (Authentication + Repair + Migrate)
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Migrate DB'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # A. Install mandatory auth plugin
        gcloud components install gke-gcloud-auth-plugin --quiet
        
        # B. Connect to  cluster
        gcloud container clusters get-credentials ${_CLUSTER_NAME} --zone ${_REGION} --project ${PROJECT_ID}
        
        # C. Update the YAML with the new image tag
        sed "s|image: .*pacs-migrations:.*|image: ${_REGION_SHORT}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/pacs-migrations:${SHORT_SHA}|g" k8s/flyway-job.yaml > flyway-run.yaml
        
        # D. Cleanup old job and apply new one
        kubectl delete job pacs-migration-job --ignore-not-found
        kubectl apply -f flyway-run.yaml
    env:
      - 'CLOUDSDK_COMPUTE_ZONE=${_REGION}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'
      - 'USE_GKE_GCLOUD_AUTH_PLUGIN=True'

substitutions:
  _REGION: us-central1-a
  _REGION_SHORT: us-central1
  _REPO_NAME: pacs-repo
  _CLUSTER_NAME: mwakilishi-cluster

options:
  logging: CLOUD_LOGGING_ONLY
  substitution_option: 'ALLOW_LOOSE'