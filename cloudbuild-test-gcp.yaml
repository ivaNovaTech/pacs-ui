steps:
  # 1. Build Migration Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Migration Image'
    args: [
      'build', 
      '-t', 'pacs-migrations:test', 
      '-f', 'backend/migrations/Dockerfile.flyway', 
      'backend/.'
    ]

  # 2. Build Backend Image (Context aligned to backend/.)
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Backend'
    args: [
      'build', 
      '-t', 'test-backend', 
      '-f', 'backend/Dockerfile', 
      'backend/.' 
    ]

  # 3. Smoke Test Backend (The Fix for DATABASE_URL)
  # This verifies the 'routes' import and the presence of 'static' files
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Smoke Test Backend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Pass dummy env so the Python code doesn't crash on the DATABASE_URL check
        docker run -d \
          --name smoke-test-backend \
          -e DATABASE_URL=postgresql://user:pass@localhost:5432/db \
          test-backend
        
        sleep 5
        docker logs smoke-test-backend
        
        if [ "$(docker inspect -f '{{.State.Running}}' smoke-test-backend)" = "false" ]; then
          echo "❌ ERROR: Backend crashed! Check the logs above for ModuleNotFoundError or path issues."
          exit 1
        fi
        
        echo "✅ SUCCESS: Backend started and found all modules."
        docker stop smoke-test-backend

  # 4. Build Frontend Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Frontend'
    args: [
      'build', 
      '-t', 'test-ui', 
      '-f', 'frontend/Dockerfile', 
      'frontend/.'
    ]

options:
  logging: CLOUD_LOGGING_ONLY